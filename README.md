## MangoHandcart

#### A rails gem for managing DNS Records, IP Authorization, and Forwarding in Ruby on Rails.

This gem is a simple Rails engine for creating Franchisee based applications. There is a Master
backend, a Franchisee end, and a Public end. It allows support for matching Franchisee's based on A-records
or subdomain matches. It also includes various IP Authorization and Forwarding strategies.

### Installation

###### Github

```ruby
gem 'mango_handcart', git: 'https://github.com/mark-d-holmberg/mango_handcart.git'
```

### Copy Migrations

MangoHandcart requires that you copy over its migrations in the following manner:

```ruby
rake mango_handcart:install:migrations
```

### Configuration

MangoHandcart can be configured via an initializer file in the following fashion:

```sh
rails g mango_handcart:config
```

This will create an initializer file for managing the MangoHandcart engine. You can use another generator
for creating the constraints JSON data file:

### Extended Configuration

```sh
rails g mango_handcart:constraints
```

This file is used for matching when deploying in different environments.

You can then use the default constraint provided by this JSON configuration file by doing the following inside your routes

```ruby
# config/routes.rb

constraints MangoHandcart::DomainConstraint.default_constraint do
  # My Routes here...
end
```

### MangoHandcart Activation

If the thing which `acts_as_handcart` responds to the method `active?`, MangoHandcart will detect that
and will not match the routing for the subdomain constraints for that handcart until that method returns true.
This allows your model to require activation before it will actually go live.


### Advanced Routing Constraints

MangoHandcart provides the ability to configure advanced routing constraints. This will allow you to match
routes only if certain conditions are met. See the following example:

```ruby
  constraints(MangoHandcart::DnsRecord) do
    resources :custom_constraints, only: [:index], constraints: MangoHandcart::SettingConstraint.new(:enables?, :custom_constraints)
    match '/', to: 'franchisee#index', via: [:get], as: :franchisee_root
  end
```

The advanced routing constraint show in this example will only match the route `/custom_constraints` if the MangoHandcart (Company) can call
`enables?(:custom_constraints)` and returns true. This allows you to check to ensure that routes are match on a per handcart basis.

### Mount the Engine

MangoHandcart needs to be mounted inside the routes file. Add the following line where appropriate:

```ruby
mount MangoHandcart::Engine => "/mango_handcart"
```

### Setup MangoHandcart Model

MangoHandcart needs to know what model is the thing that is being subdomained, i.e. a School or a Company.

```ruby
# app/models/company.rb

class Company < ActiveRecord::Base
  acts_as_handcart
end
```

### Provided Helpers

MangoHandcart gives you a few helper methods which can be used in the controller or views

* current_dns

This helper will allow you to fetch the current DNS record (assuming you're on one).

* current_handcart

This helper will allow you to fetch the current thing that is being subdomained. In the case
of the company model above, current_handcart would return the company.

* handcart_show_path(handcart)

This is a special route generated by MangoHandcart which will allow the backend to link to the
show page for the thing which `acts_as_handcart`.

If in the configuration for MangoHandcart the `handcart_show_path` was set to "companies", it
would result in the following URL:

`/companies/:id`

Where ID would be set to the id of the company. If this configuration option is not set, it will
try to infer it based on the `handcart_class` that is specified.


### Routing Helpers

MangoHandcart provides a way to apply domain/subdomain constraints to your routes. The following
is an example which uses both Domain Constraints and Subdomain Constraints.

```ruby
# config/routes.rb

Rails.application.routes.draw do
  # Allows for a Reserved Subdomain (Master Backend Interface)
  constraints(subdomain: /master/) do
    scope module: 'master' do
      match '/', to: 'dashboard#index', via: [:get], as: :master_root
    end
  end

  # Allows for Subdomains created through MangoHandcart (Franchisee Interface)
  constraints(MangoHandcart::DnsRecord) do
    match '/', to: 'franchisee#index', via: [:get], as: :franchisee_root
  end

  # Allows for Domain Constraints (Public Interface)
  constraints MangoHandcart::DomainConstraint.default_constraint do
    match '/', to: 'public#index', via: [:get], as: :public_root
  end
end
```

### IP Authorization

MangoHandcart provides support for foreign IP authorization using various built-in strategies.
The IP authorization module provides the following strategies for use when trying to authenticate foreign
IP addresses:

#### None

If the `config.ip_authorization_strategy` configuration variable is set to `:none`, then no foreign IP
authorization will occur. This means that any IP address from the outside world will be permitted to
login to the franchisee interface.

#### Containment

Setting `config.ip_authorization_strategy` to `:containment` will require that the foreign IP address
is simple included in the list of IP addresses which are allowed for the franchisee.

#### Inclusion

Setting `config.ip_authorization_strategy` to `:inclusion` will require that the foreign IP address
is included in the list of IP addresses which are allowed for the franchisee AND that the subnet of
the foreign IP address is also in the same subnet as any which are in the whitelist.

### IP Forwarding

If your application has a public interface, MangoHandcart can be configured to automatically forward
authorized foreign IP addresses to a controller action of your choosing. In addition, if they are not
authorized, it will forward them to a *public* controller action of your choosing. To invoke IP forwarding
the following settings must be configured in the initializer:

```ruby
  # config/initializers/mango_handcart.rb
  # What Rails environments enable IP forwarding and forbidden redirects
  config.global_ip_forwarding_enabled_environments = ["development", "staging", "production"]
```

Make sure that the environments in which you want IP forwarding to occur in are listed in the variable above.


#### Public Controller Invocation

To have MangoHandcart enable IP forwarding, the following method must be invoked in the `PublicController`:

```ruby
  # app/controllers/public_controller.rb
  enable_forwarding("franchisee#index", "public#forbidden", only: [:index])
```

The first argument indicates what controller and action should be invoked inside the franchisee namespace. The second
argument is the controller and action on the `PublicController` which should be invoked when the foreign IP is NOT authorized.

### IP Blocking

If you want MangoHandcart to enable the IP blocking feature, you'll need to have the following settings in the initializer:

```ruby
  # What Rails environments enable IP blocking and blacklisting
  config.global_ip_blocking_enabled_environments = ["development", "production"]
```

#### Franchisee Controller Invocation

To have MangoHandcart enable IP blocking, the following method must be invoked in a controller which is namespaced under
the franchisee:

```ruby
  # app/controllers/sessions_controller.rb
  enable_blocking("public#blocked")
```

The first argument indicates the controller and action which will be redirected to should the IP authorization strategy indicate
that the foreign IP address is NOT authorized. This method can also accept the standard options such as `only: [:index]`. The use
case for this method is designed to be the sessions controller for the franchisee. The idea is that it will not let them login to
the franchise if they're not authorized.
